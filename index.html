<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Pages Slider</title>
	
	<style>
		/* Global Styles */
		body { 
			font-family: sans-serif; 
			padding: 20px; 
			background-color: #f8f9fa;
			margin: 0;
		}
		
		/* Layout: Vertical by default (Mobile First) */
		.main-container {
			display: flex;
			flex-direction: column; 
			gap: 20px;
			align-items: center;
			width: 100%;
		}

		/* Army Column Styling */
		.army-column {
			border: 1px solid #ccc;
			padding: 20px;
			border-radius: 12px;
			width: 100%;
			max-width: 400px; /* Limits size on large mobile/tablets */
			background-color: #fff;
			box-sizing: border-box;
		}

		h3 { text-align: center; margin-top: 0; }

		/* The Slider Row */
		.row {
			display: flex;
			align-items: center;
			gap: 10px;
			margin-bottom: 15px;
		}

		.row label { 
			display: inline; 
			margin-bottom: 0; 
			flex: 0 0 100px; 
			font-weight: bold; 
		}

		.row span {
			min-width: 25px;
			font-weight: bold;
			color: #007bff;
			text-align: center;
		}

		.row input[type="range"] { 
			flex: 1; 
			margin-bottom: 0; 
			height: 30px; /* Makes slider easier to grab on touch screens */
		}

		/* --- Simulation Panel Specific Styles --- */
		.button-group {
			display: flex;
			gap: 10px;
			margin-bottom: 20px;
		}

		.btn {
			padding: 15px;
			font-weight: bold;
			cursor: pointer;
			border: none;
			border-radius: 8px;
			color: white;
			transition: opacity 0.2s;
		}

		.btn:active { opacity: 0.8; }

		.btn-fight {
			flex: 2;
			background-color: #28a745;
		}

		.btn-reset {
			flex: 1;
			background-color: #6c757d;
		}

		#battle_log {
			height: 300px;
			overflow-y: auto;
			border: 1px solid #ddd;
			padding: 10px;
			font-family: monospace;
			font-size: 0.8rem;
			background: #fdfdfd;
			border-radius: 4px;
		}

		/* DESKTOP VIEW: If screen is wider than 850px, go side-by-side */
		@media (min-width: 850px) {
			body {
				display: flex;
				justify-content: center;
				padding: 50px;
			}

			.main-container {
				flex-direction: row; /* Switch to horizontal */
				align-items: flex-start;
				justify-content: center;
				max-width: 1300px; /* Increased slightly to fit 3 columns better */
			}
		}
	</style>


</head>
<body>

<div class="main-container">
    <!-- Attacker Column -->
    <div class="army-column">
        <h3>Attacker</h3>
        <div class="row">
            <label>1x Units:</label>
            <span id="attacker_val_1">0</span>
            <input type="range" id="attacker_one_battalion_slider" min="0" max="20" value="0">
        </div>
        <div class="row">
            <label>3x Units:</label>
            <span id="attacker_val_3">0</span>
            <input type="range" id="attacker_three_battalion_slider" min="0" max="20" value="0">
        </div>
        <div class="row">
            <label>5x Units:</label>
            <span id="attacker_val_5">0</span>
            <input type="range" id="attacker_five_battalion_slider" min="0" max="20" value="0">
        </div>
        <hr>
        <div class="row">
            <label>Total Units:</label>
            <span id="attacker_total_display">0</span>
			<span id="attacker_error" style="color: red; font-weight: bold; margin-left: 5px;"></span>
        </div>
		<div class="row">
			<label>Bonuses:</label>
			<label style="flex:none; font-weight:normal;"><input type="checkbox" id="attacker_bonus_1">Leader</label>
		</div>
    </div>

    <!-- Defender Column -->
    <div class="army-column">
        <h3>Defender</h3>
        <div class="row">
            <label>1x Units:</label>
            <span id="defender_val_1">0</span>
            <input type="range" id="defender_one_battalion_slider" min="0" max="20" value="0">
        </div>
        <div class="row">
            <label>3x Units:</label>
            <span id="defender_val_3">0</span>
            <input type="range" id="defender_three_battalion_slider" min="0" max="20" value="0">
        </div>
        <div class="row">
            <label>5x Units:</label>
            <span id="defender_val_5">0</span>
            <input type="range" id="defender_five_battalion_slider" min="0" max="20" value="0">
        </div>
        <hr>
        <div class="row">
            <label>Total Units:</label>
            <span id="defender_total_display">0</span>
			<span id="defender_error" style="color: red; font-weight: bold; margin-left: 5px;"></span>
        </div>
		<div class="row">
			<label>Bonuses:</label>
			<label style="flex:none; font-weight:normal;"><input type="checkbox" id="defender_bonus_1">Leader</label>
			<label style="flex:none; font-weight:normal;"><input type="checkbox" id="defender_bonus_2">Stronghold</label>
		</div>
    </div>
		
	<div class="army-column simulation-panel">
		<h3>Simulation</h3>
		<div class="button-group">
			<button id="fight_button" style="width:100%; padding:15px; font-weight:bold; cursor:pointer; background:#28a745; color:white; border:none; border-radius:8px;">FIGHT!</button>
			<button id="reset_button" style="flex: 1; padding:15px; font-weight:bold; cursor:pointer; background:#6c757d; color:white; border:none; border-radius:8px;">Reset</button>		
		</div>
		<div id="battle_log" style="margin-top:20px; height:300px; overflow-y:auto; border:1px solid #ddd; padding:10px; font-family:monospace; font-size:0.8rem; background:#fdfdfd;">
			Waiting for battle...
		</div>
	</div>	
</div>

<script>

// Store the exact slider counts here
let snapshot = {
    attacker: { s1: 0, s3: 0, s5: 0 },
    defender: { s1: 0, s3: 0, s5: 0 }
};

function takeSnapshot() {
    snapshot.attacker.s1 = document.getElementById('attacker_one_battalion_slider').value;
    snapshot.attacker.s3 = document.getElementById('attacker_three_battalion_slider').value;
    snapshot.attacker.s5 = document.getElementById('attacker_five_battalion_slider').value;

    snapshot.defender.s1 = document.getElementById('defender_one_battalion_slider').value;
    snapshot.defender.s3 = document.getElementById('defender_three_battalion_slider').value;
    snapshot.defender.s5 = document.getElementById('defender_five_battalion_slider').value;
}

function updateArmyTotal(prefix) {
    // Select elements using the full word prefix (attacker or defender)
    const slider1 = document.getElementById(`${prefix}_one_battalion_slider`);
    const slider3 = document.getElementById(`${prefix}_three_battalion_slider`);
    const slider5 = document.getElementById(`${prefix}_five_battalion_slider`);
    const totalDisplay = document.getElementById(`${prefix}_total_display`);

	const display1 = document.getElementById(`${prefix}_val_1`);
	const display3 = document.getElementById(`${prefix}_val_3`);
	const display5 = document.getElementById(`${prefix}_val_5`);

	// Update the individual number labels
	display1.textContent = slider1.value;
	display3.textContent = slider3.value;
	display5.textContent = slider5.value;

	// Perform the weighted math
	const total = (Number(slider1.value) * 1) + 
				  (Number(slider3.value) * 3) + 
				  (Number(slider5.value) * 5);
	
	totalDisplay.textContent = total;
}

function initializeArmyCalculator(prefix) {
    // Select elements using the full word prefix (attacker or defender)
    const slider1 = document.getElementById(`${prefix}_one_battalion_slider`);
    const slider3 = document.getElementById(`${prefix}_three_battalion_slider`);
    const slider5 = document.getElementById(`${prefix}_five_battalion_slider`);
    
    // Attach listeners to all three sliders
    [slider1, slider3, slider5].forEach(slider => {
        slider.addEventListener('input', function() 
		{ 
			updateArmyTotal(prefix); 
			takeSnapshot();
		});
    });

    // Run once to set initial zeros
    updateArmyTotal(prefix);
}

// Start the logic for both columns
initializeArmyCalculator('attacker');
initializeArmyCalculator('defender');

function setArmyUnits(prefix, newTotal) {
    const slider1 = document.getElementById(`${prefix}_one_battalion_slider`);
    const slider3 = document.getElementById(`${prefix}_three_battalion_slider`);
    const slider5 = document.getElementById(`${prefix}_five_battalion_slider`);

    // Helper to get current total
    const getSum = (s1, s3, s5) => (s1 * 1) + (s3 * 3) + (s5 * 5);

    let s1 = Number(slider1.value);
    let s3 = Number(slider3.value);
    let s5 = Number(slider5.value);

    // 1. Reduction Phase: Remove units until we are AT or BELOW newTotal
    // Following your priority: 1s(to 8) -> 3s(to 5) -> 5s -> 3s -> 1s
    while (getSum(s1, s3, s5) > newTotal) {
        if (s1 > 8) { s1--; }
        else if (s3 > 5) { s3--; }
        else if (s5 > 0) { s5--; }
        else if (s3 > 0) { s3--; }
        else if (s1 > 0) { s1--; }
        else { break; } // Safety break
    }

    // 2. Refill Phase: If we "overpaid" (e.g., removed a 5 to cover a debt of 2),
    // we are now below newTotal. Add back using greedy logic to hit exact total.
    while (getSum(s1, s3, s5) < newTotal) {
        let diff = newTotal - getSum(s1, s3, s5);
        if (diff >= 3) { s3++; }
        else { s1++; }
    }

    // Apply values back
    slider1.value = s1;
    slider3.value = s3;
    slider5.value = s5;

    updateArmyTotal(prefix);
	
    // Error Checking Logic
    const totalDisplay = document.getElementById(`${prefix}_total_display`);
	const errorDisplay = document.getElementById(`${prefix}_error`);
    if (newTotal !== Number(totalDisplay.textContent)) {
        errorDisplay.textContent = "(Error)";
    } else {
        errorDisplay.textContent = ""; // Clear error if it matches or is manual
    }
}

function roll() { return Math.floor(Math.random() * 6) + 1; }

document.getElementById('fight_button').addEventListener('click', function() {
    const log = document.getElementById('battle_log');
    log.innerHTML = "<b>Battle Started!</b><br>";

    // Get current totals from your existing displays
    let attacker_army = parseInt(document.getElementById('attacker_total_display').textContent);
    let defender_army = parseInt(document.getElementById('defender_total_display').textContent);

    if (attacker_army < 2) {
        log.innerHTML += "Attacker needs at least 2 units to attack.";
        return;
    }
	
    // Calculate LOTR bonuses once at start of fight
    const attacker_bonus = (document.getElementById('attacker_bonus_1').checked ? 1 : 0);
    const defender_bonus = (document.getElementById('defender_bonus_1').checked ? 1 : 0) + 
                           (document.getElementById('defender_bonus_2').checked ? 1 : 0);

    while (attacker_army > 1 && defender_army > 0) {
        // Roll dice (3 for attacker, 2 for defender as requested)
        let a_dice = [roll(), roll(), roll()].sort((a, b) => b - a);
        let d_dice = [roll(), roll()].sort((a, b) => b - a);

        // Apply LOTR +1 Bonus to the HIGHEST die only
        a_dice[0] += attacker_bonus;
        d_dice[0] += defender_bonus;
		
        let a_loss = 0, d_loss = 0;

        // Compare top 2 dice
        for (let i = 0; i < 2; i++) {
            if (a_dice[i] > d_dice[i]) {
                defender_army--;
                d_loss++;
            } else {
                attacker_army--;
                a_loss++;
            }
            if (attacker_army <= 1 || defender_army <= 0) break;
        }

        log.innerHTML += `[${a_dice}] (-${a_loss}=${attacker_army}) vs [${d_dice}] (-${d_loss}=${defender_army})<br>`;
        log.scrollTop = log.scrollHeight; // Auto-scroll to bottom
    }

    log.innerHTML += `<br><b>Result: ${defender_army === 0 ? "Attacker Wins!" : "Defender Wins!"}</b>`;
	
	// Sync the sliders to the new reality
	setArmyUnits('attacker', attacker_army);
	setArmyUnits('defender', defender_army); 
});

document.getElementById('reset_button').addEventListener('click', function() {
    // 2. Restore the exact slider positions from the snapshot
    document.getElementById('attacker_one_battalion_slider').value = snapshot.attacker.s1;
    document.getElementById('attacker_three_battalion_slider').value = snapshot.attacker.s3;
    document.getElementById('attacker_five_battalion_slider').value = snapshot.attacker.s5;

    document.getElementById('defender_one_battalion_slider').value = snapshot.defender.s1;
    document.getElementById('defender_three_battalion_slider').value = snapshot.defender.s3;
    document.getElementById('defender_five_battalion_slider').value = snapshot.defender.s5;

    // 3. Refresh the displays to match these values
    updateArmyTotal('attacker');
    updateArmyTotal('defender');

    document.getElementById('battle_log').innerHTML = "Sliders restored to pre-battle positions.";
});


</script>

</body>
</html>
